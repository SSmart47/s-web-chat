const firebaseConfig={apiKey:"AIzaSyCgaZiQPZPEsbFF75Hues-jHAgTnTuEg44",authDomain:"swebchat-57d61.firebaseapp.com",databaseURL:"https://swebchat-57d61-default-rtdb.firebaseio.com",projectId:"swebchat-57d61",storageBucket:"swebchat-57d61.appspot.com",messagingSenderId:"1022482092623",appId:"1:1022482092623:web:cd0a82665533392662503a"};firebase.initializeApp(firebaseConfig);var username=localStorage.getItem("ss47_s_web_chat_user_i"),_u_n_=localStorage.getItem("ss47_s_web_chat_user_n");function JsonToList(e){var t,a=e,s=[];for(t in a)s.push([t,a[t]]);return s}function Part(e,t){for(var a="",s="",r=0,n=0;n<e.length;n++)"a"==e[n]?r++:0==r?a+=e[n]:s+=e[n];return 1==t?a:s}function RefreshChatList(){firebase.database().ref().child("users").get().then(e=>{if(e.exists()){var t=e.val();if(null==t[username].chats)return console.log("No Chats!"),void(document.getElementById("id_my_1").innerHTML="");var a=JsonToList(t[username].chats),e=document.getElementById("id_my_1"),s="";s+='<table class="table table-dark"><thead><tr><th scope="col">#</th><th scope="col">ИМЯ ПОЛЬЗОВАТЕЛЯ</th><th scope="col">ДЕЙСТВИЯ</th></tr></thead><tbody>';for(var r=0;r<a.length;r++){var n="",o=t[n+=a[r][0]].nick,c="";c+=a[r][1].chatid;n="";s+="<tr>",s+='<th scope="row">'+(r+1)+"</th>",s+="<td>"+o+"</td>",s+="<td>",s+='<div class="btn-group" role="group" aria-label="Basic example">',s+='<button class="btn btn-success" onclick="Pressed(\''+(n+=a[r][0])+"')\">Начать чат</button>",s+='<button class="btn btn-danger" onclick="Remove(\''+c+"')\">Удалить чат</button>",s+="</div>",s+="</td>",s+="</tr>"}s+="</tbody></table>",e.innerHTML=s}else console.log("-~-")}).catch(e=>{alert("No Connection!"),console.error(e)})}document.getElementById("id_exit_uname").innerHTML=_u_n_,document.getElementById("id_users_name").innerHTML=_u_n_,CheckUser();async function CheckUser(){firebase.database().ref().child("users").child(username).get().then(e=>{e.exists()?((e=e.val()).nick=_u_n_,firebase.database().ref("users/"+username).set(e)):firebase.database().ref("users/"+username).set({nick:_u_n_}),RefreshChatList()}).catch(e=>{alert("No Connection!"),console.error(e)})}function NameMistake(e){for(var t=0;t<e.length;t++)if(!("a"<=e[t]&&e[t]<="z"||"A"<=e[t]&&e[t]<="Z"||"0"<=e[t]&&e[t]<="9"||"_"==e[t]))return!0;return!1}function Remove(e){var t=Part(e,1),a=Part(e,2);firebase.database().ref("users/"+t+"/chats/"+a).remove(),firebase.database().ref("users/"+a+"/chats/"+t).remove(),firebase.database().ref("chats/"+e).remove(),RefreshChatList()}function FixedID(e,t){var a=parseInt(e),e=parseInt(t);return e<a&&(t=0,t+=a,a=0,a+=e,e=0,e+=t),a+"a"+e}function Pressed(e){localStorage.setItem("ss47_s_web_chat_user_i",username),localStorage.setItem("ss47_s_web_chat_user_n",_u_n_),localStorage.setItem("ss47_s_web_chat_user_o",e),localStorage.setItem("ss47_s_web_chat_user_ci",FixedID(username,e)),window.location="pages/chat/chat.html"}document.getElementById("id_btn_exit").onclick=function(){localStorage.setItem("ss47_s_web_chat_user_i",""),localStorage.setItem("ss47_s_web_chat_user_n","")},document.getElementById("id_btn_add_user").onclick=function(){var o=document.getElementById("id_new_user_name").value;o!=_u_n_?""!=o?NameMistake(o)?alert("Account Name can only contain letters, numbers and '_'"):firebase.database().ref().child("users").get().then(e=>{if(e.exists()){for(var t=JsonToList(e.val()),a=0;a<t.length;a++)if(t[a][1].nick==o){var s=parseInt(username),r=parseInt(t[a][0]),n=FixedID(s,r);return firebase.database().ref("users/"+s+"/chats/"+r).set({chatid:n}),firebase.database().ref("users/"+r+"/chats/"+s).set({chatid:n}),alert("SUCCESS!"),void RefreshChatList()}alert("User Not Found!")}else console.log("Server Error!")}).catch(e=>{alert("No Connection!"),console.error(e)}):alert("Empty Field!"):alert("You can't add yourself!")};
